<script>
    document.addEventListener('DOMContentLoaded', function() {
        const langToggleButton = document.getElementById('lang-toggle-btn');
        const mobileLangToggleButton = document.getElementById('mobile-lang-toggle-btn');
        const htmlEl = document.documentElement;
        const mobileNavToggle = document.getElementById('mobile-nav-toggle-btn'); // Use ID
        const mobileNavMenu = document.getElementById('mobile-nav-menu'); // Use ID

        // --- Language Switching Logic ---
        function setLanguage(lang) {
            const otherLang = lang === 'en' ? 'hi' : 'en';
            htmlEl.setAttribute('lang', lang);

            document.querySelectorAll(`[lang="${otherLang}"]`).forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll(`[lang="${lang}"]`).forEach(el => {
                if (el.style.display === 'none') {
                     // Determine default display style (simple approach)
                     const defaultDisplay = ['SPAN', 'A', 'SMALL', 'B', 'STRONG', 'BUTTON', 'LABEL', 'I', 'EM'].includes(el.tagName) ? 'inline' : 'block';
                      // Handle specific cases like list items etc.
                     if (el.tagName === 'LI') el.style.display = 'list-item';
                     else if (el.closest('.purchase-buttons') && el.tagName === 'A') el.style.display = 'inline-block';
                     else if (el.closest('.purchase-buttons') && el.tagName === 'P') el.style.display = 'block';
                      else if (el.closest('.social-media-list') && el.tagName === 'LI') el.style.display = 'inline-block';
                      else if (el.closest('.social-media-list') && el.tagName === 'SPAN') el.style.display = 'inline';

                     else el.style.display = defaultDisplay; // Apply determined or default style
                 }
            });

            localStorage.setItem('preferredLanguage', lang);
            // updateActiveNavLinks function call removed from here to avoid potential conflict on initial load
            // It will be called separately after initial language setup.
        }

        function toggleLanguage() {
            const currentLang = htmlEl.getAttribute('lang') || 'en';
            const newLang = currentLang === 'en' ? 'hi' : 'en';
            setLanguage(newLang);
        }

        if (langToggleButton) {
            langToggleButton.addEventListener('click', toggleLanguage);
        }
        if (mobileLangToggleButton) {
            mobileLangToggleButton.addEventListener('click', (event) => {
                 event.stopPropagation(); // Prevent closing nav immediately
                toggleLanguage();
                closeMobileNav(); // Close after language change
            });
        }

        const savedLang = localStorage.getItem('preferredLanguage');
        const initialLang = savedLang || 'en';
        htmlEl.setAttribute('lang', initialLang);
        setLanguage(initialLang); // Apply initial language visibility

        // --- Mobile Navigation Toggle Logic ---
        function closeMobileNav() {
            if (mobileNavMenu) mobileNavMenu.classList.remove('is-active'); // Use class
            if (mobileNavToggle) mobileNavToggle.setAttribute('aria-expanded', 'false');
        }

        if (mobileNavToggle && mobileNavMenu) {
            mobileNavToggle.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent document listener
                const isActive = mobileNavMenu.classList.toggle('is-active'); // Toggle class
                mobileNavToggle.setAttribute('aria-expanded', isActive);
            });

             // Close nav when clicking a link inside it
             const mobileNavLinks = mobileNavMenu.querySelectorAll('a.page-link');
             mobileNavLinks.forEach(link => {
                 link.addEventListener('click', () => {
                     setTimeout(closeMobileNav, 150);
                 });
             });

             // Close when clicking inside the menu but not on a link/button
             mobileNavMenu.addEventListener('click', (event) => {
                 // Allow clicks on links and language button within the menu
                 if (!event.target.closest('a.page-link') && !event.target.closest('.mobile-lang-switch button')) {
                     event.stopPropagation(); // Prevent closing if clicking empty space inside menu
                 }
             });
        }

         // Close mobile nav when clicking outside
         document.addEventListener('click', (event) => {
             if (mobileNavMenu && mobileNavMenu.classList.contains('is-active') &&
                 !mobileNavMenu.contains(event.target) &&
                 !mobileNavToggle.contains(event.target)) {
                 closeMobileNav();
             }
         });


        // --- Active Nav Link Highlighting ---
        const sections = document.querySelectorAll('section');
        const navLinksDesktop = document.querySelectorAll('.desktop-nav .page-link');
        const navLinksMobileAll = document.querySelectorAll('.mobile-nav .page-link');
        const headerHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height'), 10) || 70;

        function updateActiveNavLinks(targetId) {
            const currentHash = targetId || '#home';
            // Use try...catch for querySelector in case hash is invalid
            try {
                if (!document.querySelector(currentHash)) {
                    console.warn("Target ID for active link not found:", currentHash);
                    return; // Exit if target doesn't exist
                }
            } catch (e) {
                 console.error("Error selecting target for active link:", currentHash, e);
                 return;
            }

            navLinksDesktop.forEach(link => {
                 link.classList.toggle('active', link.getAttribute('href') === currentHash);
            });
             navLinksMobileAll.forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === currentHash);
             });
        }

        const observerOptions = {
          root: null,
          rootMargin: `-${headerHeight + 10}px 0px -75% 0px`,
          threshold: 0
        };

        const observerCallback = (entries) => {
            let intersectingEntry = null;
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                     if (!intersectingEntry || entry.boundingClientRect.top < intersectingEntry.boundingClientRect.top) {
                         intersectingEntry = entry;
                     }
                }
            });
             if (intersectingEntry) {
                updateActiveNavLinks(`#${intersectingEntry.target.id}`);
             } else if (window.pageYOffset < 100) { // Check if near top
                  updateActiveNavLinks('#home');
             }
        };

        const observer = new IntersectionObserver(observerCallback, observerOptions);
        sections.forEach(section => observer.observe(section));

         window.addEventListener('hashchange', () => {
             updateActiveNavLinks(window.location.hash || '#home');
         });

         // Initial active link check on load
         setTimeout(() => {
              let initialHash = '#home';
              if(window.location.hash && document.querySelector(window.location.hash)) {
                  initialHash = window.location.hash;
              } else {
                 for (let section of sections) {
                    const rect = section.getBoundingClientRect();
                    if (rect.top >= 0 && rect.top < window.innerHeight / 3) {
                        initialHash = '#' + section.id;
                        break;
                     }
                 }
              }
             updateActiveNavLinks(initialHash);
         }, 150);

    }); // End DOMContentLoaded
</script>

</body>
</html>
